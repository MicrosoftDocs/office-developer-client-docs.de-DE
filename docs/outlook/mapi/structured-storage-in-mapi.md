---
title: Strukturierte Storage in MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Letzte Änderung: Montag, 9. März 2015'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411750"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="b70ec-103">Strukturierte Storage in MAPI</span><span class="sxs-lookup"><span data-stu-id="b70ec-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="b70ec-104">**Gilt für**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="b70ec-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="b70ec-105">Strukturierter Speicher bezieht sich auf die hierarchische Organisation des Speichers, die mit COM eingeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="b70ec-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="b70ec-106">In einer strukturierten Speicherumgebung ist der Speicher in zwei oder drei Arten von Objekten organisiert:</span><span class="sxs-lookup"><span data-stu-id="b70ec-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="b70ec-107">Stream-Objekte</span><span class="sxs-lookup"><span data-stu-id="b70ec-107">Stream objects</span></span>
    
- <span data-ttu-id="b70ec-108">Sperren von Byteobjekten</span><span class="sxs-lookup"><span data-stu-id="b70ec-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="b70ec-109">Storage-Objekte</span><span class="sxs-lookup"><span data-stu-id="b70ec-109">Storage objects</span></span>
    
<span data-ttu-id="b70ec-110">Stream- und Sperrbytes sind Objekte auf niedrigerer Ebene, die direkt auf die Daten zugreifen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="b70ec-111">Stream-Objekte implementieren die **IStream-Schnittstelle,** die Methoden zum Lesen, Schreiben, Positionieren und Kopieren von Bytes von Daten definiert.</span><span class="sxs-lookup"><span data-stu-id="b70ec-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="b70ec-112">Lock Bytes-Objekte implementieren eine weitere COM-Schnittstelle, **ILockBytes**, um auf Daten mit einem Bytearray zu zugreifen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="b70ec-113">Bytearrays werden in der Regel verwendet, um benutzerdefinierten Zugriff auf den zugrunde liegenden Speicher zu ermöglichen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="b70ec-114">Storage Objekte werden über dem Stream oder dem Sperren von Byteobjekten überschichtet. sie können eines oder mehrere dieser Objekte sowie andere Speicherobjekte enthalten.</span><span class="sxs-lookup"><span data-stu-id="b70ec-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="b70ec-115">Storage-Objekte implementieren die **IStorage-Schnittstelle,** die Methoden zum Erstellen, Zugreifen und Verwalten geschachtelter Objekte definiert.</span><span class="sxs-lookup"><span data-stu-id="b70ec-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="b70ec-116">Da **IStream,** **ILockBytes** und **IStorage** KEINE MAPI-Schnittstellen, sondern COM-Schnittstellen sind, geben ihre Methoden COM-Fehlerwerte anstelle von MAPI-Werten zurück.</span><span class="sxs-lookup"><span data-stu-id="b70ec-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="b70ec-117">Clients und Dienstanbieter, die Methoden in diesen Schnittstellen aufrufen, müssen die API-Funktion **MapStorageSCode** verwenden, um diese Werte in MAPI-Fehlerwerte zu übersetzen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="b70ec-118">Weitere Informationen finden Sie unter [MapStorageSCode](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="b70ec-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="b70ec-119">Clients und Dienstanbieter verwenden strukturierten Speicher für die Arbeit mit Eigenschaften, die zu groß sind, um sie mit den **IMAPIProp-Methoden** zu verwalten, in der Regel große Zeichenfolgen- und binäre Eigenschaften.</span><span class="sxs-lookup"><span data-stu-id="b70ec-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="b70ec-120">Eine der gängigen Methoden, auf die Clients oder Dienstanbieter zugreifen, besteht in der Angabe von **IStream** oder **IStorage** als Schnittstellenbezeichner in einem Aufruf der [IMAPIProp::OpenProperty-Methode.](imapiprop-openproperty.md)</span><span class="sxs-lookup"><span data-stu-id="b70ec-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="b70ec-121">Clients rufen z. B. **OpenProperty** mit **PR_ATTACH_DATA_BIN** als Eigenschaftstag und IID_IStream als Schnittstellen-ID auf, um auf eine binäre Anlage in einer Nachricht zu zugreifen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="b70ec-122">Clients und Dienstanbieter können eigene Stream- und Speicherobjekte implementieren oder API-Funktionen aufrufen, um auf von MAPI oder COM bereitgestellte Implementierungen zu zugreifen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="b70ec-123">Da die bereitgestellten Implementierungen den meisten Zwecken dienen, müssen Clients und Dienstanbieter selten eigene Erstellen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="b70ec-124">Wenn ein Client **OpenProperty für** ein MAPI-Objekt aufruft, um über ein Speicherobjekt auf eine seiner Eigenschaften zu zugreifen, öffnet der Dienstanbieter das Speicherobjekt in der Regel im direkten Modus.</span><span class="sxs-lookup"><span data-stu-id="b70ec-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="b70ec-125">Dies ist jedoch ein typisches und nicht erforderliches Verhalten.</span><span class="sxs-lookup"><span data-stu-id="b70ec-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="b70ec-126">Clients sollten davon ausgehen, dass alle von Dienstanbietern geöffneten oder erstellten Speicherobjekte transaktiviert werden und einen Aufruf von **IStorage::Commit erfordern.**</span><span class="sxs-lookup"><span data-stu-id="b70ec-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="b70ec-127">Sie sollten auch bedenken, dass Änderungen an Speicherobjekten erst dauerhaft vorgenommen werden, wenn **sie IMAPIProp::SaveChanges** nach dem letzten **Commit** zum Speichern des MAPI-Objekts aufrufen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="b70ec-128">Weitere Informationen finden Sie unter [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="b70ec-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="b70ec-129">MAPI und COM bieten verschiedene API-Funktionen zum Definieren oder Zugreifen auf Speicher- und Streamobjekte.</span><span class="sxs-lookup"><span data-stu-id="b70ec-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="b70ec-130">Die häufig verwendeten Funktionen werden in der folgenden Tabelle beschrieben.</span><span class="sxs-lookup"><span data-stu-id="b70ec-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="b70ec-131">**Funktionen für den Zugriff Storage und Stream-Objekte**</span><span class="sxs-lookup"><span data-stu-id="b70ec-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="b70ec-132">**Funktion**</span><span class="sxs-lookup"><span data-stu-id="b70ec-132">**Function**</span></span>|<span data-ttu-id="b70ec-133">**Beschreibung**</span><span class="sxs-lookup"><span data-stu-id="b70ec-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="b70ec-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="b70ec-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="b70ec-135">Erstellt ein Speicherobjekt für den Zugriff auf ein Stream- oder Sperrbyteobjekt.</span><span class="sxs-lookup"><span data-stu-id="b70ec-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="b70ec-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="b70ec-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="b70ec-137">Erstellt ein Nachrichtenobjekt für den Zugriff auf ein Speicherobjekt.</span><span class="sxs-lookup"><span data-stu-id="b70ec-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="b70ec-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="b70ec-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="b70ec-139">Erstellt ein Streamobjekt für den Zugriff auf eine Datei.</span><span class="sxs-lookup"><span data-stu-id="b70ec-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="b70ec-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="b70ec-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="b70ec-141">Erstellt ein Streamobjekt, das die komprimierte oder nicht komprimierte Version eines Datenstroms mit dem Rich-Text einer Nachricht enthält.</span><span class="sxs-lookup"><span data-stu-id="b70ec-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="b70ec-142">**So rufen Sie die Namen der Datenströme in einem bestimmten Unterordner ab**</span><span class="sxs-lookup"><span data-stu-id="b70ec-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="b70ec-143">Rufen Sie die **IStorage::EnumElements-Methode** des Unterordners auf, um eine **IEnumSTATSTG-Schnittstelle zu** erhalten.</span><span class="sxs-lookup"><span data-stu-id="b70ec-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="b70ec-144">Rufen **Sie IEnumSTATSTG::Next** mit möglichst vielen **STATSTG-Strukturen** gleichzeitig auf.</span><span class="sxs-lookup"><span data-stu-id="b70ec-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="b70ec-145">Wenn Sie gleichzeitig nach 100 fragen, gibt **Next** in der Regel S_FALSE zurück, bei dem der Inhalt von  _pceltFetched_ auf die Tatsächlich abgerufene Nummer festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="b70ec-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="b70ec-146">Suchen Sie nach **den STATSTG-Strukturen,** die mit STGTY_STREAM.</span><span class="sxs-lookup"><span data-stu-id="b70ec-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="b70ec-147">Geben Sie den  _pwcsName-Parameter_ frei.</span><span class="sxs-lookup"><span data-stu-id="b70ec-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="b70ec-148">**So erstellen Sie ein Speicherobjekt für den Zugriff auf ein vorhandenes Stream- oder Sperrbyteobjekt**</span><span class="sxs-lookup"><span data-stu-id="b70ec-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="b70ec-149">Clients rufen [HrIStorageFromStream auf.](hristoragefromstream.md)</span><span class="sxs-lookup"><span data-stu-id="b70ec-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="b70ec-150">**So erstellen Sie ein Nachrichtenobjekt für den Zugriff auf ein vorhandenes Speicherobjekt**</span><span class="sxs-lookup"><span data-stu-id="b70ec-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="b70ec-151">Dienstanbieter und Clients rufen [OpenIMsgOnIStg auf.](openimsgonistg.md)</span><span class="sxs-lookup"><span data-stu-id="b70ec-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="b70ec-152">Das erstellte Nachrichtenobjekt unterscheidet sich von den Nachrichtenobjekten, die normalerweise von Nachrichtenspeicheranbietern erstellt werden, da es nicht alle [IMessage : IMAPIProp-Schnittstellenmethoden](imessageimapiprop.md) unterstützt, z. B. **IMessage::SubmitMessage**.</span><span class="sxs-lookup"><span data-stu-id="b70ec-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="b70ec-153">Ein optionaler Eingabeparameter für **OpenIMsgOnIStg** ist eine Rückruffunktion, die dem [MSGCALLRELEASE-Prototyp entspricht.](msgcallrelease.md)</span><span class="sxs-lookup"><span data-stu-id="b70ec-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="b70ec-154">Diese Funktion wird vom neuen Message-Objekt aufgerufen, wenn die Referenzanzahl der Nachricht null erreicht.</span><span class="sxs-lookup"><span data-stu-id="b70ec-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="b70ec-155">Das Implementieren einer **MSGCALLRELEASE-Funktion** kann für die endgültige Verarbeitung nützlich sein, bevor die neue Nachricht vollständig entfernt wird.</span><span class="sxs-lookup"><span data-stu-id="b70ec-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="b70ec-156">[OpenStreamOnFile](openstreamonfile.md) wird häufig zum Speichern von Dateianlagen verwendet, da es einen Datenstrom erstellt, der aus einer Datei liest und in eine Datei schreibt.</span><span class="sxs-lookup"><span data-stu-id="b70ec-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="b70ec-157">**OpenProperty** mit **PR_ATTACH_DATA_BIN** als Eigenschaftstag erstellt einen Datenstrom zum Speichern binärer Anlagendaten.</span><span class="sxs-lookup"><span data-stu-id="b70ec-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="b70ec-158">**So komprimieren oder entkomprimieren Sie einen Datenstrom mit Nachrichtentext im Rich-Text-Format**</span><span class="sxs-lookup"><span data-stu-id="b70ec-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="b70ec-159">Clients rufen [WrapCompressedRTFStream auf.](wrapcompressedrtfstream.md)</span><span class="sxs-lookup"><span data-stu-id="b70ec-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="b70ec-160">**WrapCompressedRTFStream** erstellt einen Datenstrom, der den RTF-Stream umschließt.</span><span class="sxs-lookup"><span data-stu-id="b70ec-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="b70ec-161">Der Wrapperstream implementiert nicht alle **IStream-Methoden.** Die folgenden Methoden werden ausgeschlossen: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat** und **Clone**.</span><span class="sxs-lookup"><span data-stu-id="b70ec-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="b70ec-162">Dies liegt daran, dass die von **WrapCompressedRTFStream** erstellten Streamobjekte **weder SetSize** noch **Stat** unterstützen. Es gibt keine einfache Möglichkeit, ihre Größe zu erweitern oder abzurufen.</span><span class="sxs-lookup"><span data-stu-id="b70ec-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="b70ec-163">Die beste Strategie besteht in der Auswahl einer angemessenen Puffergröße und dem Lesen oder Schreiben in einer Schleife.</span><span class="sxs-lookup"><span data-stu-id="b70ec-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="b70ec-164">COM verfügt über eine Speicherobjektimplementierung basierend auf einem Bytearray, das ein **IEnumSTATSTG-Objekt** aus der **problematischen EnumElements-Methode** zurückgibt.</span><span class="sxs-lookup"><span data-stu-id="b70ec-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="b70ec-165">Insbesondere die **QueryInterface-Methode** funktioniert nicht ordnungsgemäß.</span><span class="sxs-lookup"><span data-stu-id="b70ec-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="b70ec-166">Dienstanbieter, die ihre eigenen Speicherobjekte mithilfe der COM-Implementierung implementieren, sollten einen dünnen Wrapper für das **IEnumSTATSTG-Objekt** erstellen, das Aufrufe an die zugrunde liegenden **IEnumSTATSTG-Methoden** weiter gibt, aber eigene **AddRef-,** **Release-,** **QueryInterface-** und **Clone-Methoden** implementiert.</span><span class="sxs-lookup"><span data-stu-id="b70ec-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

